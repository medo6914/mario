<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Currency Converter — Final Version</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#e9edf5;
    --card:#ffffff;
    --text:#111;
    --primary:#0076ff;
    --accent:#ffb200;
  }
  [data-theme="dark"]{
    --bg:#121212;
    --card:#1f1f1f;
    --text:#eee;
    --primary:#3a8bff;
    --accent:#ffb84d;
  }
  [data-theme="green"]{
    --bg:#ecf9f0;
    --card:#ffffff;
    --text:#073b22;
    --primary:#18a663;
    --accent:#ffd166;
  }

  html,body{
    margin:0;
    padding:0;
    font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    transition:background .25s, color .25s;
    height:100%;
  }

  .wrap{
    max-width:820px;
    margin:28px auto;
    padding:18px;
  }

  .app{
    background:var(--card);
    border-radius:14px;
    padding:18px;
    box-shadow:0 10px 30px rgba(0,0,0,0.12);
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:18px;
    align-items:start;
  }

  h1{ margin:0 0 10px 0; font-size:20px; text-align:center; }

  /* form */
  .controls{
    padding:8px;
  }
  label{ display:block; margin:10px 0 6px 0; font-size:14px; }
  input[type=number], select{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #cfcfcf;
    font-size:15px;
    box-sizing:border-box;
    background:transparent;
    color:var(--text);
  }

  .row{
    display:flex;
    gap:10px;
  }

  .btn{
    cursor:pointer;
    border:none;
    padding:10px 12px;
    border-radius:8px;
    background:var(--primary);
    color:white;
    font-weight:600;
  }
  .btn.secondary{ background:var(--accent); color:#111; }

  .swap{
    text-align:center;
    display:block;
    margin:8px auto;
    background:transparent;
    border:1px dashed #bbb;
    padding:8px 12px;
    border-radius:12px;
    cursor:pointer;
  }

  #result{
    margin-top:14px;
    font-size:18px;
    font-weight:700;
    text-align:center;
    min-height:36px;
  }

  .meta{
    display:flex;
    gap:10px;
    justify-content:space-between;
    align-items:center;
    margin-top:10px;
  }

  .loader{ width:40px; height:40px; border:4px solid #ddd; border-top-color:var(--primary); border-radius:50%; animation:spin .8s linear infinite; display:none; margin:12px auto; }
  @keyframes spin{ to{ transform:rotate(360deg); } }

  /* side panel */
  .panel{
    padding:12px;
    border-left:1px solid rgba(0,0,0,0.05);
  }
  .panel h3{ margin:0 0 10px 0; font-size:16px; text-align:center; }

  .small{ font-size:13px; color:gray; }

  /* chart canvas */
  #chart{ width:100%; background:transparent; }

  /* footer controls */
  .controls-bottom{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; align-items:center; justify-content:center; }
  .theme-select, .share-btn, .fullscreen-btn{ padding:8px 10px; border-radius:8px; border:1px solid #ccc; background:transparent; cursor:pointer; }

  /* responsive */
  @media (max-width:900px){
    .app{ grid-template-columns: 1fr; }
    .panel{ border-left:none; border-top:1px solid rgba(0,0,0,0.05); margin-top:12px; }
  }

  /* snackbar (copy/share) */
  .snack{
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    bottom:18px;
    background:#222;
    color:#fff;
    padding:10px 14px;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(0,0,0,0.25);
    display:none;
    z-index:9999;
  }
</style>
</head>
<body data-theme="light">

<div class="wrap">
  <div class="app" id="appRoot">

    <div class="controls">
      <h1>Currency Converter — Final Version</h1>

      <label for="amount">Amount</label>
      <input id="amount" type="number" placeholder="Enter amount" min="0" step="any">

      <div class="row" style="margin-top:8px;">
        <div style="flex:1">
          <label for="from">From</label>
          <select id="from"></select>
        </div>
        <div style="width:14px"></div>
        <div style="flex:1">
          <label for="to">To</label>
          <select id="to"></select>
        </div>
      </div>

      <button class="swap" id="swapBtn" title="Swap Currencies">Swap Currencies ??</button>

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="convertBtn">Convert</button>
        <button class="btn secondary" id="clearBtn">Clear</button>
      </div>

      <div class="meta">
        <div class="small">Last Saved Result: <span id="lastSaved" class="small">—</span></div>
        <div><div id="loader" class="loader" aria-hidden="true"></div></div>
      </div>

      <div id="result" role="status" aria-live="polite"></div>

      <div class="controls-bottom" style="margin-top:8px;">
        <select id="themeSelect" class="theme-select" title="Select Theme">
          <option value="light">Default Theme</option>
          <option value="dark">Dark Theme</option>
          <option value="green">Green Theme</option>
        </select>

        <button id="darkToggle" class="fullscreen-btn" title="Toggle Dark Mode">Toggle Dark</button>
        <button id="shareBtn" class="share-btn" title="Share Result">Share Result</button>
        <button id="fullscreenBtn" class="fullscreen-btn" title="Fullscreen">Fullscreen</button>
        <button id="offlineNote" class="share-btn" style="pointer-events:none;background:transparent;border:0;color:gray;">Status: <span id="onlineState">Online</span></button>
      </div>

    </div>

    <div class="panel">
      <h3>Last 7 Days Chart</h3>
      <canvas id="chart"></canvas>

      <div style="margin-top:12px;">
        <div class="small">Advanced Options:</div>
        <div style="margin-top:8px;">
          <button id="saveConfig" class="btn" style="width:100%;">Save Settings</button>
        </div>
        <div style="margin-top:8px;">
          <button id="downloadOffline" class="btn secondary" style="width:100%;">Download for Offline</button>
        </div>

        <hr style="margin:12px 0;">
        <div class="small">Auto Save: <span id="autoSave">Enabled</span></div>
        <div class="small" style="margin-top:6px;">Works Offline after clicking "Download for Offline"</div>
      </div>

    </div>

  </div>
</div>

<div id="snack" class="snack" role="status" aria-live="polite">Copied</div>

<script>
/* =========== Variables =========== */
const amountEl = document.getElementById('amount');
const fromEl = document.getElementById('from');
const toEl = document.getElementById('to');
const convertBtn = document.getElementById('convertBtn');
const clearBtn = document.getElementById('clearBtn');
const swapBtn = document.getElementById('swapBtn');
const resultEl = document.getElementById('result');
const loaderEl = document.getElementById('loader');
const lastSavedEl = document.getElementById('lastSaved');
const chartCanvas = document.getElementById('chart');
const snack = document.getElementById('snack');
const shareBtn = document.getElementById('shareBtn');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const darkToggle = document.getElementById('darkToggle');
const themeSelect = document.getElementById('themeSelect');
const onlineState = document.getElementById('onlineState');
const saveConfigBtn = document.getElementById('saveConfig');
const downloadOfflineBtn = document.getElementById('downloadOffline');
const autoSaveEl = document.getElementById('autoSave');

/* =========== Beep sound using WebAudio =========== */
function playBeep(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = 880;
    g.gain.value = 0.05;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 120);
  }catch(e){}
}

/* =========== Load currencies (dynamic from API) =========== */
async function loadCurrencies(){
  try{
    const res = await fetch('https://open.er-api.com/v6/latest/USD');
    const data = await res.json();
    const list = Object.keys(data.rates);
    // populate selects
    fromEl.innerHTML = '';
    toEl.innerHTML = '';
    list.forEach(c=>{
      const o1 = document.createElement('option'); o1.value=c; o1.textContent=c;
      const o2 = document.createElement('option'); o2.value=c; o2.textContent=c;
      fromEl.appendChild(o1);
      toEl.appendChild(o2);
    });
    // load saved config or defaults
    const cfg = JSON.parse(localStorage.getItem('cfg') || '{}');
    fromEl.value = cfg.from || 'USD';
    toEl.value = cfg.to || 'EGP';
    themeSelect.value = cfg.theme || 'light';
    document.body.setAttribute('data-theme', cfg.theme || 'light');
    if(cfg.dark === true) document.body.setAttribute('data-theme','dark');
    // load last result
    const last = localStorage.getItem('lastResult');
    if(last){ lastSavedEl.textContent = last; resultEl.innerHTML = last; }
    else lastSavedEl.textContent = '—';
    // initial history chart (may be empty until first convert)
    await loadHistory(fromEl.value, toEl.value);
  }catch(e){
    console.warn('loadCurrencies error', e);
    // fallback list
    const fallback = ['USD','EUR','EGP','GBP','SAR','JPY','AUD','CAD','CNY'];
    fromEl.innerHTML = ''; toEl.innerHTML = '';
    fallback.forEach(c=>{ fromEl.add(new Option(c,c)); toEl.add(new Option(c,c)); });
  }
}

/* =========== Swap currencies =========== */
swapBtn.addEventListener('click', ()=>{
  const a = fromEl.value; fromEl.value = toEl.value; toEl.value = a;
});

/* =========== Convert =========== */
let chartInstance = null;
convertBtn.addEventListener('click', async ()=>{
  const amt = parseFloat(amountEl.value);
  if(!amt && amt !== 0){ alert('Enter amount first'); return; }
  const from = fromEl.value, to = toEl.value;
  loaderEl.style.display = 'block';
  resultEl.textContent = '';
  try{
    const api = `https://open.er-api.com/v6/latest/${from}`;
    const res = await fetch(api);
    const data = await res.json();
    const rate = data.rates[to];
    if(!rate){ throw new Error('Rate unavailable'); }
    const final = (amt * rate);
    const finalText = `${amt} ${from} = ${final.toFixed(4)} ${to}`;
    resultEl.textContent = finalText;
    lastSavedEl.textContent = finalText;
    playBeep();
    // autosave
    if(localStorage.getItem('autoSave') !== 'false') localStorage.setItem('lastResult', finalText);
    // save current config
    const cfg = { from, to, theme: themeSelect.value, dark: document.body.getAttribute('data-theme')==='dark' };
    localStorage.setItem('cfg', JSON.stringify(cfg));
    // draw 7-day history
    await loadHistory(from, to);
  }catch(err){
    resultEl.textContent = 'Error fetching rates';
    console.error(err);
  }finally{
    loaderEl.style.display = 'none';
  }
});

/* =========== Clear inputs =========== */
clearBtn.addEventListener('click', ()=>{
  amountEl.value = '';
  resultEl.textContent = '';
});

/* =========== Load last 7 days history and draw chart =========== */
async function loadHistory(base, target){
  try{
    const labels = [], values = [];
    for(let i=7;i>=1;i--){
      const d = new Date(); d.setDate(d.getDate() - i);
      const iso = d.toISOString().split('T')[0];
      // using exchangerate.host
      const url = `https://api.exchangerate.host/${iso}?base=${base}&symbols=${target}`;
      const r = await fetch(url);
      const json = await r.json();
      labels.push(iso);
      values.push(json.rates && json.rates[target] ? json.rates[target] : null);
    }
    drawChart(labels, values, base, target);
  }catch(e){
    console.warn('loadHistory err', e);
  }
}

function drawChart(labels, data, base, target){
  // filter out null values
  const filteredLabels = [], filteredData = [];
  for(let i=0;i<labels.length;i++){
    if(data[i] != null){ filteredLabels.push(labels[i]); filteredData.push(data[i]); }
  }
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(chartCanvas.getContext('2d'), {
    type:'line',
    data:{
      labels: filteredLabels,
      datasets:[{
        label:`${base} ? ${target} (Last 7 Days)`,
        data: filteredData,
        borderWidth:2,
        tension:0.25,
        borderColor:getComputedStyle(document.body).getPropertyValue('--primary').trim() || '#0076ff',
        fill:false,
        pointRadius:3
      }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{ display:true, position:'top' } }
    }
  });
}

/* =========== Share result (Web Share or clipboard) =========== */
shareBtn.addEventListener('click', async ()=>{
  const txt = resultEl.textContent || lastSavedEl.textContent || '';
  if(!txt){ showSnack('No result to share'); return; }
  if(navigator.share){
    try{ await navigator.share({ title:'Conversion Result', text: txt }); showSnack('Shared'); return; }
    catch(e){ /* share canceled */ }
  }
  // fallback: copy to clipboard
  try{
    await navigator.clipboard.writeText(txt);
    showSnack('Text copied to clipboard');
  }catch(e){
    showSnack('Copy failed — copy manually: ' + txt);
  }
});

/* =========== Fullscreen =========== */
fullscreenBtn.addEventListener('click', async ()=>{
  try{
    if(!document.fullscreenElement){
      await document.documentElement.requestFullscreen();
    } else {
      await document.exitFullscreen();
    }
  }catch(e){ console.warn(e); }
});

/* =========== Dark and themes =========== */
darkToggle.addEventListener('click', ()=>{
  const cur = document.body.getAttribute('data-theme');
  if(cur==='dark'){ document.body.setAttribute('data-theme','light'); themeSelect.value='light'; }
  else{ document.body.setAttribute('data-theme','dark'); themeSelect.value='dark'; }
});

themeSelect.addEventListener('change', (e)=>{
  const v = e.target.value;
  document.body.setAttribute('data-theme', v);
});

/* =========== Save settings manually =========== */
saveConfigBtn.addEventListener('click', ()=>{
  const cfg = { from: fromEl.value, to: toEl.value, theme: themeSelect.value, dark: document.body.getAttribute('data-theme')==='dark' };
  localStorage.setItem('cfg', JSON.stringify(cfg));
  showSnack('Settings saved');
});

/* =========== Offline: register Service Worker via Blob (inline) =========== */
async function registerSW(){
  if('serviceWorker' in navigator){
    try{
      const swCode = `
        const CACHE_NAME = 'currency-app-cache-v1';
        const ASSETS = [
          '/',
          'https://cdn.jsdelivr.net/npm/chart.js'
        ];
        self.addEventListener('install', e=>{
          self.skipWaiting();
          e.waitUntil(
            caches.open(CACHE_NAME).then(cache=>{
              return cache.addAll(ASSETS).catch(()=>{/*ignore*/});
            })
          );
        });
        self.addEventListener('activate', e=>{
          e.waitUntil(self.clients.claim());
        });
        self.addEventListener('fetch', e=>{
          const url = new URL(e.request.url);
          e.respondWith(
            fetch(e.request).then(res=>{ return res; }).catch(()=>{
              return caches.match(e.request).then(resp=> resp || caches.match('/'));
            })
          );
        });
      `;
      const blob = new Blob([swCode], { type: 'text/javascript' });
      const swUrl = URL.createObjectURL(blob);
      await navigator.serviceWorker.register(swUrl);
      console.log('Service Worker registered (inline)');
    }catch(e){ console.warn('SW register failed', e); }
  }
}

/* button to download/save resources to cache (manual) */
downloadOfflineBtn.addEventListener('click', async ()=>{
  if(!('caches' in window)){ showSnack('Browser does not support caching'); return; }
  try{
    const cache = await caches.open('currency-app-cache-v1');
    await cache.addAll([
      '/',
      'https://cdn.jsdelivr.net/npm/chart.js'
    ].filter(Boolean));
    showSnack('Offline assets downloaded');
  }catch(e){
    showSnack('Failed downloading assets: ' + e.message);
  }
});

/* =========== Online status =========== */
function updateOnlineStatus(){
  onlineState.textContent = navigator.onLine ? 'Online' : 'Offline';
}
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();

/* =========== Snackbar helper =========== */
function showSnack(msg, t=2200){
  snack.textContent = msg;
  snack.style.display = 'block';
  setTimeout(()=>{ snack.style.display = 'none'; }, t);
}

/* =========== Default autosave setting =========== */
if(localStorage.getItem('autoSave') === null) localStorage.setItem('autoSave','true');

/* =========== Initial load and SW register =========== */
loadCurrencies().then(()=>registerSW());

/* =========== Show last saved result in sidebar =========== */
(function showLastSaved(){
  const last = localStorage.getItem('lastResult');
  if(last) lastSavedEl.textContent = last;
})();

</script>
</body>
</html>
